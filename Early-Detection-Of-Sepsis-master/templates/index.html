<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepsis Risk Prediction - Clinical Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Sticky Header -->
    <header class="sticky-header">
        <div class="header-container">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-heartbeat"></i>
                    <h1>Sepsis Risk Prediction</h1>
                </div>
                <p class="header-subtitle">AI-Powered Clinical Risk Assessment Dashboard</p>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="content-wrapper">
            <!-- Form Section -->
            <form id="predictionForm" action="/predict" method="post" class="medical-form">
                <!-- Vital Signs Section -->
                <section class="form-card">
                    <div class="card-header">
                        <i class="fas fa-heartbeat"></i>
                        <h2>Vital Signs</h2>
                    </div>
                    <div class="form-grid">
                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-heart"></i></div>
                            <div class="input-field">
                                <label>Heart Rate</label>
                                <input class="form-control" type="number" name="HR" min="0" step="0.01" placeholder="60-100 bpm">
                                <span class="input-hint">60-100 bpm</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-wind"></i></div>
                            <div class="input-field">
                                <label>O₂ Saturation</label>
                                <input class="form-control" type="number" name="O2Sat" min="0" step="0.01" max="100" placeholder=">95%">
                                <span class="input-hint">>95%</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-thermometer-half"></i></div>
                            <div class="input-field">
                                <label>Temperature</label>
                                <input class="form-control" type="number" name="Temp" min="0" step="0.01" placeholder="36.5-37.5°C">
                                <span class="input-hint">36.5-37.5°C</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-arrow-up"></i></div>
                            <div class="input-field">
                                <label>Systolic BP</label>
                                <input class="form-control" type="number" name="SBP" min="0" step="0.01" placeholder="90-120 mmHg">
                                <span class="input-hint">90-120 mmHg</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-gauge"></i></div>
                            <div class="input-field">
                                <label>Mean Arterial Pressure</label>
                                <input class="form-control" type="number" name="MAP" min="0" step="0.01" placeholder="70-100 mmHg">
                                <span class="input-hint">70-100 mmHg</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-arrow-down"></i></div>
                            <div class="input-field">
                                <label>Diastolic BP</label>
                                <input class="form-control" type="number" name="DBP" min="0" step="0.01" placeholder="60-80 mmHg">
                                <span class="input-hint">60-80 mmHg</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-lungs"></i></div>
                            <div class="input-field">
                                <label>Respiration Rate</label>
                                <input class="form-control" type="number" name="Resp" min="0" step="0.01" placeholder="12-20 breaths/min">
                                <span class="input-hint">12-20 breaths/min</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Laboratory Values Section -->
                <section class="form-card">
                    <div class="card-header">
                        <i class="fas fa-flask"></i>
                        <h2>Laboratory Values</h2>
                    </div>
                    <div class="form-grid">
                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-test"></i></div>
                            <div class="input-field">
                                <label>Base Excess</label>
                                <input class="form-control" type="number" name="BaseExcess" step="0.01" placeholder="-3 to +3 mmol/L">
                                <span class="input-hint">-3 to +3 mmol/L</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-droplet"></i></div>
                            <div class="input-field">
                                <label>Bicarbonate (HCO₃)</label>
                                <input class="form-control" type="number" name="HCO3" step="0.01" placeholder="22-26 mmol/L">
                                <span class="input-hint">22-26 mmol/L</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-percent"></i></div>
                            <div class="input-field">
                                <label>FiO₂</label>
                                <input class="form-control" type="number" name="FiO2" min="0" step="0.01" max="100" placeholder="21% room air">
                                <span class="input-hint">21-100%</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-gauge"></i></div>
                            <div class="input-field">
                                <label>PaCO₂</label>
                                <input class="form-control" type="number" name="PaCO2" step="0.01" placeholder="35-45 mmHg">
                                <span class="input-hint">35-45 mmHg</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-wind"></i></div>
                            <div class="input-field">
                                <label>SaO₂</label>
                                <input class="form-control" type="number" name="SaO2" min="0" step="0.01" max="100" placeholder=">95%">
                                <span class="input-hint">>95%</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-flask"></i></div>
                            <div class="input-field">
                                <label>Creatinine</label>
                                <input class="form-control" type="number" name="Creatinine" step="0.01" placeholder="0.7-1.3 mg/dL">
                                <span class="input-hint">0.7-1.3 mg/dL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-vial"></i></div>
                            <div class="input-field">
                                <label>Bilirubin Direct</label>
                                <input class="form-control" type="number" name="Bilirubin_direct" step="0.01" placeholder="0.0-0.3 mg/dL">
                                <span class="input-hint">0.0-0.3 mg/dL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-candy"></i></div>
                            <div class="input-field">
                                <label>Glucose</label>
                                <input class="form-control" type="number" name="Glucose" step="0.01" placeholder="70-100 mg/dL">
                                <span class="input-hint">70-100 mg/dL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-droplet-slash"></i></div>
                            <div class="input-field">
                                <label>Lactate</label>
                                <input class="form-control" type="number" name="Lactate" step="0.01" placeholder="0.5-2.0 mmol/L">
                                <span class="input-hint">0.5-2.0 mmol/L</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-magnet"></i></div>
                            <div class="input-field">
                                <label>Magnesium</label>
                                <input class="form-control" type="number" name="Magnesium" step="0.01" placeholder="1.7-2.2 mg/dL">
                                <span class="input-hint">1.7-2.2 mg/dL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-circle"></i></div>
                            <div class="input-field">
                                <label>Phosphate</label>
                                <input class="form-control" type="number" name="Phosphate" step="0.01" placeholder="2.5-4.5 mg/dL">
                                <span class="input-hint">2.5-4.5 mg/dL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-vial"></i></div>
                            <div class="input-field">
                                <label>Bilirubin Total</label>
                                <input class="form-control" type="number" name="Bilirubin_total" step="0.01" placeholder="0.1-1.2 mg/dL">
                                <span class="input-hint">0.1-1.2 mg/dL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-blood"></i></div>
                            <div class="input-field">
                                <label>Hemoglobin</label>
                                <input class="form-control" type="number" name="Hgb" step="0.01" placeholder="13.5-17.5 g/dL">
                                <span class="input-hint">13.5-17.5 g/dL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-virus"></i></div>
                            <div class="input-field">
                                <label>White Blood Cells</label>
                                <input class="form-control" type="number" name="WBC" step="0.01" placeholder="4.5-11 K/µL">
                                <span class="input-hint">4.5-11 K/µL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-link"></i></div>
                            <div class="input-field">
                                <label>Fibrinogen</label>
                                <input class="form-control" type="number" name="Fibrinogen" step="0.01" placeholder="200-400 mg/dL">
                                <span class="input-hint">200-400 mg/dL</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-coins"></i></div>
                            <div class="input-field">
                                <label>Platelets</label>
                                <input class="form-control" type="number" name="Platelets" step="0.01" placeholder="150-400 K/µL">
                                <span class="input-hint">150-400 K/µL</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Demographics Section -->
                <section class="form-card">
                    <div class="card-header">
                        <i class="fas fa-user"></i>
                        <h2>Patient Demographics</h2>
                    </div>
                    <div class="form-grid">
                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-birthday-cake"></i></div>
                            <div class="input-field">
                                <label>Age</label>
                                <input class="form-control" type="number" name="Age" placeholder="Enter age (100 for >90)" min="0" step="0.01">
                                <span class="input-hint">Years of age</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-person"></i></div>
                            <div class="input-field">
                                <label>Gender</label>
                                <input class="form-control" type="number" name="Gender" placeholder="0=Female, 1=Male" min="0" step="1" max="1">
                                <span class="input-hint">0=Female, 1=Male</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-clock"></i></div>
                            <div class="input-field">
                                <label>Hospital to ICU</label>
                                <input class="form-control" type="number" name="HospAdmTime" placeholder="Hours" min="0" max="999" step="0.01">
                                <span class="input-hint">Hours (positive)</span>
                            </div>
                        </div>

                        <div class="input-group-card">
                            <div class="input-icon"><i class="fas fa-hourglass-end"></i></div>
                            <div class="input-field">
                                <label>ICU Length of Stay</label>
                                <input class="form-control" type="number" name="ICULOS" placeholder="Hours in ICU" min="0" max="999" step="0.01">
                                <span class="input-hint">Hours in ICU (positive)</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Action Buttons -->
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-stethoscope"></i> Predict Sepsis Risk
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="generateRandomValues()">
                        <i class="fas fa-dice"></i> Generate Random Values
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-redo"></i> Clear Form
                    </button>
                </div>
            </form>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner" style="display:none;">
                <div class="spinner"></div>
                <p>Analyzing patient data...</p>
            </div>

            <!-- Results Section -->
            <div id="resultSection" class="result-section" style="display:none;">
                <div class="result-card">
                    <div class="result-header">
                        <i class="fas fa-clipboard-check"></i>
                        <h2>Risk Assessment Result</h2>
                    </div>
                    <div id="predictionResult" class="prediction-result"></div>
                    
                    <!-- Explainability Section -->
                    <div id="explanationSection" style="margin-top: 25px; display:none;">
                        <h3 class="explanation-title">
                            <i class="fas fa-info-circle"></i> Clinical Insights
                        </h3>
                        <div id="explanation"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        // Normal ranges for each field
        const normalRanges = {
            // Vital Signs
            'HR': { min: 60, max: 100, label: 'beats/min' },
            'O2Sat': { min: 95, max: 100, label: '%' },
            'Temp': { min: 36.5, max: 37.5, label: '°C' },
            'SBP': { min: 90, max: 120, label: 'mmHg' },
            'MAP': { min: 70, max: 100, label: 'mmHg' },
            'DBP': { min: 60, max: 80, label: 'mmHg' },
            'Resp': { min: 12, max: 20, label: 'breaths/min' },
            
            // Laboratory Values
            'BaseExcess': { min: -3, max: 3, label: 'mmol/L' },
            'HCO3': { min: 22, max: 26, label: 'mmol/L' },
            'FiO2': { min: 21, max: 100, label: '%' },
            'PaCO2': { min: 35, max: 45, label: 'mmHg' },
            'SaO2': { min: 95, max: 100, label: '%' },
            'Creatinine': { min: 0.7, max: 1.3, label: 'mg/dL' },
            'Bilirubin_direct': { min: 0.0, max: 0.3, label: 'mg/dL' },
            'Glucose': { min: 70, max: 100, label: 'mg/dL' },
            'Lactate': { min: 0.5, max: 2.0, label: 'mmol/L' },
            'Magnesium': { min: 1.7, max: 2.2, label: 'mg/dL' },
            'Phosphate': { min: 2.5, max: 4.5, label: 'mg/dL' },
            'Bilirubin_total': { min: 0.1, max: 1.2, label: 'mg/dL' },
            'Hgb': { min: 13.5, max: 17.5, label: 'g/dL' },
            'WBC': { min: 4.5, max: 11, label: 'K/µL' },
            'Fibrinogen': { min: 200, max: 400, label: 'mg/dL' },
            'Platelets': { min: 150, max: 400, label: 'K/µL' },
            
            // Demographics
            'Age': { min: 18, max: 90, label: 'years' },
            'Gender': { min: 0, max: 1, label: '', isInteger: true },
            'HospAdmTime': { min: 0, max: 72, label: 'hours' },
            'ICULOS': { min: 0, max: 120, label: 'hours' }
        };

        function generateRandomValues() {
            // Get all input fields
            const inputs = document.querySelectorAll('input[type="number"]');
            
            // Define vital signs and laboratory fields
            const vitalFields = ['HR', 'O2Sat', 'Temp', 'SBP', 'MAP', 'DBP', 'Resp'];
            const labFields = ['BaseExcess', 'HCO3', 'FiO2', 'PaCO2', 'SaO2', 'Creatinine', 
                              'Bilirubin_direct', 'Glucose', 'Lactate', 'Magnesium', 'Phosphate', 
                              'Bilirubin_total', 'Hgb', 'WBC', 'Fibrinogen', 'Platelets'];
            const demoFields = ['Age', 'Gender', 'HospAdmTime', 'ICULOS'];
            
            // Select exactly 2 random vital fields to be abnormal
            const abnormalVitalFields = vitalFields.sort(() => Math.random() - 0.5).slice(0, 2);
            
            // Select exactly 4 random lab fields to be abnormal
            const abnormalLabFields = labFields.sort(() => Math.random() - 0.5).slice(0, 4);
            
            // Generate all values
            inputs.forEach(input => {
                const fieldName = input.name;
                let result;
                
                if (fieldName === 'HospAdmTime' || fieldName === 'ICULOS') {
                    // For hours fields, ensure they're in range 5-15
                    result = {
                        value: parseFloat((Math.random() * 10 + 5).toFixed(2)),
                        isAbnormal: false
                    };
                } else if (fieldName === 'Age') {
                    // Age: 18-90
                    result = {
                        value: Math.round(Math.random() * 72 + 18),
                        isAbnormal: false
                    };
                } else if (fieldName === 'Gender') {
                    // Gender: 0 or 1
                    result = {
                        value: Math.round(Math.random()),
                        isAbnormal: false
                    };
                } else if (abnormalVitalFields.includes(fieldName)) {
                    // Force abnormal for selected vital fields
                    result = generateAbnormalValue(fieldName);
                } else if (abnormalLabFields.includes(fieldName)) {
                    // Force abnormal for selected lab fields
                    result = generateAbnormalValue(fieldName);
                } else {
                    // Generate normal values for the rest
                    result = generateNormalValue(fieldName);
                }
                
                if (result && result.value !== '') {
                    input.value = result.value;

                    // Find the label and add asterisk if abnormal
                    const inputField = input.closest('.input-field');
                    if (inputField) {
                        const label = inputField.querySelector('label');
                        if (label) {
                            // Remove existing asterisk
                            label.textContent = label.textContent.replace(' *', '');
                            
                            // Add asterisk if abnormal
                            if (result.isAbnormal) {
                                label.textContent += ' *';
                                label.style.color = '#ff9f43';
                            } else {
                                label.style.color = '#ffd700';
                            }
                        }
                    }
                }
            });

            // Show a notification with summary
            const summary = `Random values generated`;
            showNotification(summary);
        }

        function generateNormalValue(fieldName) {
            const range = normalRanges[fieldName];
            if (!range) return '';

            let value = range.min + (Math.random() * (range.max - range.min));

            if (range.isInteger) {
                value = Math.round(value);
            } else {
                value = parseFloat(value.toFixed(2));
            }

            return { value, isAbnormal: false };
        }

        function generateAbnormalValue(fieldName) {
            const range = normalRanges[fieldName];
            if (!range) return '';

            let value;
            // Generate value outside normal range
            if (Math.random() < 0.5) {
                // Below normal
                value = range.min - (Math.random() * (range.max - range.min) * 0.3);
            } else {
                // Above normal
                value = range.max + (Math.random() * (range.max - range.min) * 0.3);
            }

            if (range.isInteger) {
                value = Math.round(value);
            } else {
                value = parseFloat(value.toFixed(2));
            }

            return { value, isAbnormal: true };
        }

        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <i class="fas fa-info-circle"></i> ${message}
            `;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: rgba(255, 215, 0, 0.1);
                border: 2px solid #ffd700;
                border-radius: 10px;
                padding: 15px 20px;
                color: #ffd700;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.5s ease-out;
                max-width: 350px;
            `;

            document.body.appendChild(notification);

            // Remove notification after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 4000);
        }

        function resetForm() {
            // Reset all inputs
            document.getElementById('predictionForm').reset();
            
            // Remove asterisks and reset label colors
            const labels = document.querySelectorAll('label');
            labels.forEach(label => {
                label.textContent = label.textContent.replace(' *', '');
                label.style.color = '#ffd700';
            });

            localStorage.removeItem('formValues');
            showNotification('Form cleared and labels reset.');
        }

        // Form submission with loading animation
        document.getElementById('predictionForm').addEventListener('submit', function(e) {
            const formData = new FormData(this);
            const values = {};
            for (let [key, value] of formData.entries()) {
                values[key] = value;
            }
            localStorage.setItem('formValues', JSON.stringify(values));
            
            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('resultSection').style.display = 'none';
        });

        // Load form values from localStorage
        window.addEventListener('load', function() {
            // Always start with empty form
            localStorage.removeItem('formValues');
            document.getElementById('predictionForm').reset();
            
            // Reset all label colors
            const labels = document.querySelectorAll('label');
            labels.forEach(label => {
                label.textContent = label.textContent.replace(' *', '');
                label.style.color = '#ffd700';
            });

            // Check if there's a prediction result
            const predictionDiv = document.getElementById('predictionResult');
            if (predictionDiv && predictionDiv.innerHTML.trim() !== '') {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('resultSection').style.display = 'block';
                predictionDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        });

        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Inline result injection from Flask -->
    <script>
        {% if prediction_text %}
        document.addEventListener('DOMContentLoaded', function() {
            const predictionDiv = document.getElementById('predictionResult');
            const resultHTML = `
                <div class="result-text">
                    <span class="result-label">Risk Assessment:</span>
                    <div class="result-value">{{ prediction_text | safe }}</div>
                </div>
            `;
            predictionDiv.innerHTML = resultHTML;
            
            {% if confidence %}
            const confidenceHTML = `<p class="confidence-text"><strong>Confidence:</strong> <span>{{ confidence | safe }}</span></p>`;
            predictionDiv.innerHTML += confidenceHTML;
            {% endif %}
            
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'none';
            
            {% if explanation %}
            document.getElementById('explanationSection').style.display = 'block';
            document.getElementById('explanation').innerHTML = `{{ explanation | safe }}`;
            {% endif %}
            
            // Scroll to result
            setTimeout(() => {
                predictionDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        });
        {% endif %}
    </script>
</body>
</html>
